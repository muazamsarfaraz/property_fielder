<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="property_fielder_field_service.EnhancedDispatchView">
        <div class="o_enhanced_dispatch_view">
            <!-- Top Navigation Bar -->
            <div class="dispatch-navbar">
                <div class="dispatch-brand">
                    <i class="fa fa-map-marked-alt" title="Dispatch"/>
                    <span>Dispatch</span>
                </div>

                <!-- Date Navigation (Prominent, Center-Left) -->
                <div class="dispatch-date-nav">
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onPrevDay" title="Previous Day">
                        <i class="fa fa-chevron-left"/>
                    </button>
                    <div class="date-display">
                        <input type="date"
                               class="form-control form-control-sm date-input"
                               t-att-value="state.selectedDate"
                               t-on-change="onDateChange"/>
                        <button type="button" class="btn btn-sm btn-today" t-on-click="onToday" title="Go to Today">
                            Today
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onNextDay" title="Next Day">
                        <i class="fa fa-chevron-right"/>
                    </button>
                </div>

                <!-- Progress Stepper (Non-clickable indicators) -->
                <div class="dispatch-stepper">
                    <div t-attf-class="stepper-step {{ state.activeTab === 'plan' ? 'active' : '' }} {{ canAccessOptimize() ? 'completed' : '' }}">
                        <span class="stepper-number">1</span>
                        <span class="stepper-label">Select</span>
                    </div>
                    <div class="stepper-connector" t-attf-class="{{ canAccessOptimize() ? 'completed' : '' }}"/>
                    <div t-attf-class="stepper-step {{ state.activeTab === 'optimize' ? 'active' : '' }} {{ canAccessSchedule() ? 'completed' : '' }} {{ !canAccessOptimize() ? 'locked' : '' }}">
                        <span class="stepper-number">2</span>
                        <span class="stepper-label">Optimize</span>
                    </div>
                    <div class="stepper-connector" t-attf-class="{{ canAccessSchedule() ? 'completed' : '' }}"/>
                    <div t-attf-class="stepper-step {{ state.activeTab === 'schedule' ? 'active' : '' }} {{ !canAccessSchedule() ? 'locked' : '' }}">
                        <span class="stepper-number">3</span>
                        <span class="stepper-label">Schedule</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="dispatch-controls">
                    <button type="button" class="btn btn-sm btn-icon-refresh" t-on-click="onRefresh" title="Refresh data">
                        <i class="fa fa-sync"/>
                    </button>

                    <!-- Test Data Dropdown (Subtle, Ghost Button Style) -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-ghost dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false" title="Test Data for Demo">
                            <i class="fa fa-flask"/>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Demo Test Data</li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click.prevent="onLoadTestData">
                                    <i class="fa fa-plus text-success me-2"/> Load 20 Test Jobs
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" t-on-click.prevent="onDeleteTestData">
                                    <i class="fa fa-trash me-2"/> Delete All Test Data
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content Area - CSS Grid Layout -->
            <div t-attf-class="dispatch-content {{ state.sidebarCollapsed ? 'sidebar-collapsed' : '' }}">
                <!-- Expand button (visible when sidebar collapsed) -->
                <button class="sidebar-expand-button" t-on-click="toggleSidebar" title="Expand sidebar">
                    <i class="fa fa-chevron-right"/>
                </button>

                <!-- DOCKED SIDEBAR (Slides in/out) -->
                <div class="dispatch-sidebar">
                    <!-- Sidebar Header with Toggle -->
                    <div class="sidebar-header">
                        <span class="sidebar-title">
                            <i t-if="state.activeTab === 'plan'" class="fa fa-list-check"/>
                            <i t-if="state.activeTab === 'optimize'" class="fa fa-magic"/>
                            <i t-if="state.activeTab === 'schedule'" class="fa fa-calendar-check"/>
                            <t t-if="state.activeTab === 'plan'">Plan Resources</t>
                            <t t-if="state.activeTab === 'optimize'">Optimize Routes</t>
                            <t t-if="state.activeTab === 'schedule'">Schedule View</t>
                        </span>
                        <button class="btn btn-sm btn-sidebar-collapse" t-on-click="toggleSidebar" t-att-title="state.sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                            <i t-attf-class="fa fa-chevron-{{ state.sidebarCollapsed ? 'right' : 'left' }}"/>
                        </button>
                    </div>

                    <!-- Sidebar Content (scrollable) -->
                    <div class="sidebar-content" t-if="!state.sidebarCollapsed">
                        <!-- PLAN Tab Content -->
                        <t t-if="state.activeTab === 'plan'">
                            <!-- Sidebar Tab Bar (Jobs | Inspectors) -->
                            <div class="sidebar-tab-bar">
                                <button t-attf-class="sidebar-tab {{ state.sidebarTab === 'jobs' ? 'active' : '' }}"
                                        t-on-click="() => this.setSidebarTab('jobs')">
                                    <i class="fa fa-briefcase"/> Jobs
                                    <span class="tab-badge" t-if="state.selectedJobIds.length > 0">
                                        <t t-esc="state.selectedJobIds.length"/>
                                    </span>
                                </button>
                                <button t-attf-class="sidebar-tab {{ state.sidebarTab === 'inspectors' ? 'active' : '' }}"
                                        t-on-click="() => this.setSidebarTab('inspectors')">
                                    <i class="fa fa-user-tie"/> Inspectors
                                    <span class="tab-badge" t-if="state.selectedInspectorIds.length > 0">
                                        <t t-esc="state.selectedInspectorIds.length"/>
                                    </span>
                                </button>
                            </div>

                            <!-- Jobs Tab Content -->
                            <div class="sidebar-tab-content" t-if="state.sidebarTab === 'jobs'">
                                <!-- Quick Filter Pills (Issue 4 - visible filter toggles) -->
                                <!-- NFR-UX-QW3: Added descriptive tooltips to filter pills -->
                                <div class="quick-filter-pills">
                                    <button t-attf-class="filter-pill {{ state.activeQuickFilter === 'all' ? 'active' : '' }}"
                                            t-on-click="() => this.setQuickFilter('all')"
                                            title="Show all jobs for the selected date, regardless of status">
                                        All <span class="pill-count"><t t-esc="state.jobs.length"/></span>
                                    </button>
                                    <button t-attf-class="filter-pill filter-unassigned {{ state.activeQuickFilter === 'unassigned' ? 'active' : '' }}"
                                            t-on-click="() => this.setQuickFilter('unassigned')"
                                            title="Jobs not yet assigned to an inspector or route - select these to optimize">
                                        Unassigned <span class="pill-count"><t t-esc="unassignedCount"/></span>
                                    </button>
                                    <button t-attf-class="filter-pill filter-scheduled {{ state.activeQuickFilter === 'scheduled' ? 'active' : '' }}"
                                            t-on-click="() => this.setQuickFilter('scheduled')"
                                            title="Jobs that have been assigned to a route and are ready for dispatch">
                                        Scheduled <span class="pill-count"><t t-esc="scheduledCount"/></span>
                                    </button>
                                    <button t-attf-class="filter-pill filter-urgent {{ state.activeQuickFilter === 'urgent' ? 'active' : '' }}"
                                            t-on-click="() => this.setQuickFilter('urgent')"
                                            t-if="urgentCount > 0"
                                            title="High priority jobs or jobs past their deadline - requires immediate attention">
                                        <span class="urgent-dot"/> Urgent <span class="pill-count"><t t-esc="urgentCount"/></span>
                                    </button>
                                </div>

                                <!-- Search and View Controls -->
                                <div class="search-view-row">
                                    <!-- Search -->
                                    <div class="search-filter">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="fa fa-search"/></span>
                                            <input type="text" class="form-control" placeholder="Search..."
                                                   t-att-value="state.jobSearchQuery"
                                                   t-on-input="onJobSearchInput"/>
                                            <button class="btn btn-outline-secondary" type="button" t-on-click="clearJobSearch"
                                                    t-if="state.jobSearchQuery">
                                                <i class="fa fa-times"/>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- View Toggle + Count (Issue 3 - Compact view) -->
                                    <div class="view-controls">
                                        <button t-attf-class="btn btn-xs {{ state.compactViewMode ? 'btn-primary' : 'btn-outline-secondary' }}"
                                                t-on-click="toggleCompactView" title="Compact View">
                                            <i t-attf-class="fa {{ state.compactViewMode ? 'fa-list' : 'fa-th-list' }}"/>
                                        </button>
                                        <span class="job-count-label"><t t-esc="filteredJobs.length"/>/<t t-esc="state.jobs.length"/></span>
                                    </div>
                                </div>

                                <!-- Sticky Quick Action Bar (appears when jobs selected) -->
                                <div class="quick-action-bar" t-if="state.selectedJobIds.length > 0">
                                    <div class="selection-info">
                                        <span class="selection-count"><t t-esc="state.selectedJobIds.length"/></span>
                                        <span class="selection-label">selected</span>
                                    </div>
                                    <div class="quick-actions">
                                        <button class="btn btn-sm btn-primary quick-assign-btn"
                                                t-on-click="onQuickAssign"
                                                title="Assign to inspector">
                                            <i class="fa fa-user-plus me-1"/> Assign
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary"
                                                t-on-click="clearJobSelection"
                                                title="Clear selection">
                                            <i class="fa fa-times"/>
                                        </button>
                                    </div>
                                </div>

                                <!-- Job List -->
                                <div t-attf-class="resource-list jobs-list {{ state.compactViewMode ? 'compact-mode' : '' }}">
                                    <t t-foreach="filteredJobs" t-as="job" t-key="job.id">
                                        <div t-attf-class="resource-item job-item {{ state.selectedJobIds.includes(job.id) ? 'selected' : '' }} {{ state.hoveredJobId === job.id ? 'hovered' : '' }} {{ state.mapHoveredJobId === job.id ? 'map-hovered' : '' }}"
                                             t-att-data-status="job.state"
                                             t-att-data-overdue="isJobOverdue(job)"
                                             t-on-click="() => this.toggleJobSelection(job.id)"
                                             t-on-mouseenter="() => this.onJobListHover(job.id)"
                                             t-on-mouseleave="() => this.onJobListHover(null)">
                                            <div class="job-item-checkbox">
                                                <input type="checkbox" t-att-checked="state.selectedJobIds.includes(job.id)"/>
                                            </div>
                                            <div class="job-item-content">
                                                <!-- Primary: Property name (bold) -->
                                                <div class="job-property-name" t-esc="getPropertyName(job)"/>
                                                <!-- Address line (hidden in compact mode) -->
                                                <div class="job-address" t-if="!state.compactViewMode" t-esc="getJobAddress(job)"/>
                                                <!-- Meta row: icon-based status + urgent indicator + times + cert type + inspector -->
                                                <div class="job-item-meta">
                                                    <!-- Icon-based status indicator (Gemini UX: use icons instead of text) -->
                                                    <span t-attf-class="job-status-icon status-{{ job.state }}" t-att-title="getStatusLabel(job.state)">
                                                        <i t-if="job.state === 'draft'" class="fa fa-circle-o"/>
                                                        <i t-if="job.state === 'pending'" class="fa fa-clock-o"/>
                                                        <i t-if="job.state === 'scheduled'" class="fa fa-calendar"/>
                                                        <i t-if="job.state === 'assigned'" class="fa fa-user"/>
                                                        <i t-if="job.state === 'in_progress'" class="fa fa-spinner"/>
                                                        <i t-if="job.state === 'completed'" class="fa fa-check"/>
                                                        <i t-if="job.state === 'cancelled'" class="fa fa-ban"/>
                                                    </span>
                                                    <!-- NFR-UX-QW5: Certification type icon with FLAGE+ color coding -->
                                                    <span class="job-cert-type" t-att-title="getCertTypeName(job)">
                                                        <span t-attf-class="cert-icon {{ getCertTypeClass(job) }}">
                                                            <t t-esc="getCertTypeIcon(job)"/>
                                                        </span>
                                                    </span>
                                                    <!-- NFR-UX-3.4: Inspector name if assigned -->
                                                    <span class="job-inspector" t-if="job.inspector_id and job.inspector_id[1]" t-att-title="'Assigned to: ' + job.inspector_id[1]">
                                                        <i class="fa fa-user-circle-o"/> <t t-esc="getInspectorShortName(job)"/>
                                                    </span>
                                                    <!-- Overdue indicator with icon (replaces "LATE" text) -->
                                                    <span class="job-overdue-icon" t-if="isJobOverdue(job)" title="Overdue - Past deadline">
                                                        <i class="fa fa-exclamation-triangle"/>
                                                    </span>
                                                    <!-- Time info with clock icon (GEMINI UX: Add icon for clarity) -->
                                                    <span class="job-time-info" t-if="job.latest_end" t-att-title="'Deadline: ' + job.latest_end">
                                                        <i class="fa fa-clock-o"/> <t t-esc="formatTime(job.latest_end)"/>
                                                    </span>
                                                </div>
                                            </div>
                                            <!-- Quick action on hover (Issue: Quick-Assign) -->
                                            <div class="job-hover-actions" t-if="job.state === 'draft'">
                                                <button class="btn btn-xs btn-primary quick-assign-single"
                                                        t-on-click.stop="(ev) => this.onQuickAssignSingle(job.id, ev)"
                                                        title="Quick assign this job">
                                                    <i class="fa fa-user-plus"/>
                                                </button>
                                            </div>
                                        </div>
                                    </t>
                                    <!-- Enhanced Empty State for Jobs -->
                                    <t t-if="state.jobs.length === 0">
                                        <div class="empty-state-card">
                                            <div class="empty-state-illustration">
                                                <i class="fa fa-building primary"/>
                                                <i class="fa fa-clipboard-check accent"/>
                                            </div>
                                            <h5>No inspections scheduled</h5>
                                            <p>Schedule property inspections to see jobs here. Jobs are created from properties with due certifications.</p>
                                            <div class="empty-state-actions">
                                                <button type="button" class="btn btn-sm btn-primary" t-on-click="onGoToProperties">
                                                    <i class="fa fa-building me-1"/> View Properties
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" t-on-click="onLoadTestData">
                                                    <i class="fa fa-flask me-1"/> Load Demo
                                                </button>
                                            </div>
                                            <div class="empty-state-hint">
                                                <i class="fa fa-lightbulb"/>
                                                <span>Tip: Use the date picker above to check other days</span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Inspectors Tab Content -->
                            <div class="sidebar-tab-content" t-if="state.sidebarTab === 'inspectors'">
                                <!-- Context hint when jobs are selected -->
                                <div class="inspector-context-hint" t-if="state.selectedJobIds.length > 0">
                                    <i class="fa fa-info-circle"/>
                                    <span>Select inspectors to handle <strong><t t-esc="state.selectedJobIds.length"/></strong> selected job(s)</span>
                                </div>
                                <!-- Inspector Actions -->
                                <div class="tab-actions">
                                    <button class="btn btn-xs btn-outline-primary" t-on-click="selectAllInspectors">
                                        <i class="fa fa-check-double me-1"/> All Available
                                    </button>
                                    <button class="btn btn-xs btn-outline-secondary" t-on-click="clearInspectorSelection">
                                        <i class="fa fa-times me-1"/> Clear
                                    </button>
                                    <span class="inspector-count-label">
                                        <t t-esc="availableInspectors.length"/>/<t t-esc="state.inspectors.length"/> available
                                    </span>
                                </div>
                                <!-- Inspector List -->
                                <div class="resource-list inspectors-list">
                                    <t t-foreach="state.inspectors" t-as="inspector" t-key="inspector.id">
                                        <div t-attf-class="resource-item inspector-item {{ state.selectedInspectorIds.includes(inspector.id) ? 'selected' : '' }} {{ !inspector.available ? 'unavailable' : '' }}"
                                             t-on-click="() => this.toggleInspectorSelection(inspector.id)">
                                            <input type="checkbox" t-att-checked="state.selectedInspectorIds.includes(inspector.id)"/>
                                            <div class="inspector-info">
                                                <div class="inspector-name-row">
                                                    <span class="resource-name" t-esc="inspector.name"/>
                                                    <span class="inspector-availability" t-if="inspector.available">
                                                        <span class="availability-dot available"/>
                                                    </span>
                                                    <span class="inspector-availability" t-else="">
                                                        <span class="availability-dot unavailable"/>
                                                    </span>
                                                </div>
                                                <div class="inspector-details">
                                                    <span class="inspector-shift" t-if="inspector.shift_start">
                                                        <i class="fa fa-clock"/> <t t-esc="inspector.shift_start"/> - <t t-esc="inspector.shift_end"/>
                                                    </span>
                                                    <span t-attf-class="inspector-status-pill {{ inspector.available ? 'available' : 'unavailable' }}">
                                                        <t t-if="inspector.available">Ready</t>
                                                        <t t-else="">Off Duty</t>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    <!-- Enhanced Empty State for Inspectors -->
                                    <t t-if="state.inspectors.length === 0">
                                        <div class="empty-state-card compact">
                                            <div class="empty-state-illustration small">
                                                <i class="fa fa-user-tie primary"/>
                                                <i class="fa fa-hard-hat accent"/>
                                            </div>
                                            <h6>No inspectors configured</h6>
                                            <p>Add inspectors to assign them to routes and schedule inspections.</p>
                                            <button type="button" class="btn btn-sm btn-outline-primary" t-on-click="onGoToInspectors">
                                                <i class="fa fa-user-plus me-1"/> Add Inspector
                                            </button>
                                        </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Optimization Settings (only visible on Optimize tab) -->
                            <t t-if="state.activeTab === 'optimize'">
                                <div class="sidebar-section collapsible optimization-settings">
                                    <div class="section-header clickable" t-on-click="toggleSettingsSection">
                                        <h6><i class="fa fa-cog"/> Optimization Settings</h6>
                                        <i t-attf-class="fa fa-chevron-{{ state.settingsExpanded ? 'up' : 'down' }}"/>
                                    </div>
                                    <div class="section-body" t-if="state.settingsExpanded">
                                        <div class="setting-group">
                                            <label class="form-label">Solver Time Limit</label>
                                            <select class="form-select form-select-sm">
                                                <option value="30">30 seconds</option>
                                                <option value="60" selected="">1 minute</option>
                                                <option value="180">3 minutes</option>
                                                <option value="300">5 minutes</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label class="form-label">Optimization Mode</label>
                                            <select class="form-select form-select-sm">
                                                <option value="balanced">Balanced</option>
                                                <option value="minimize_distance">Minimize Distance</option>
                                                <option value="minimize_time">Minimize Time</option>
                                                <option value="maximize_jobs">Maximize Jobs</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="useOsrm" checked=""/>
                                                <label class="form-check-label" for="useOsrm">Use OSRM for routing</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="respectTimeWindows" checked=""/>
                                                <label class="form-check-label" for="respectTimeWindows">Respect time windows</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Quick Optimize Button (always visible in Plan tab) -->
                            <div class="sidebar-footer">
                                <button type="button"
                                        t-attf-class="btn {{ optimizeButtonClass }} btn-lg w-100 {{ optimizeButtonDisabled ? 'disabled-with-reason' : '' }}"
                                        t-att-disabled="optimizeButtonDisabled"
                                        t-on-click="startOptimization"
                                        t-att-title="state.selectedJobIds.length === 0 ? 'Select jobs first' : state.selectedInspectorIds.length === 0 ? 'Select inspectors first' : 'Run route optimization'">
                                    <t t-if="state.optimizationRunning">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"/>
                                        Optimizing...
                                    </t>
                                    <t t-elif="state.optimizationComplete and state.routes.length > 0">
                                        <i class="fa fa-check-circle me-2"/> <t t-esc="optimizeButtonText"/>
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-magic me-2"/> <t t-esc="optimizeButtonText"/>
                                    </t>
                                </button>
                                <div class="selection-summary" t-if="state.selectedJobIds.length > 0 || state.selectedInspectorIds.length > 0">
                                    <span><t t-esc="state.selectedJobIds.length"/> <t t-if="state.selectedJobIds.length === 1">job</t><t t-else="">jobs</t></span>
                                    <span class="separator">â€¢</span>
                                    <span><t t-esc="state.selectedInspectorIds.length"/> <t t-if="state.selectedInspectorIds.length === 1">inspector</t><t t-else="">inspectors</t></span>
                                </div>
                                <div class="prereq-hint" t-if="state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0">
                                    <i class="fa fa-info-circle"/>
                                    <t t-if="state.selectedJobIds.length === 0 &amp;&amp; state.selectedInspectorIds.length === 0">
                                        Select jobs and inspectors to optimize
                                    </t>
                                    <t t-elif="state.selectedJobIds.length === 0">
                                        Select at least one job
                                    </t>
                                    <t t-else="">
                                        Select at least one inspector
                                    </t>
                                </div>
                            </div>
                        </t>

                        <!-- OPTIMIZE Tab Content -->
                        <t t-if="state.activeTab === 'optimize'">
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-check-circle"/> Selected Resources</h6>
                                </div>
                                <div class="selection-cards">
                                    <div class="selection-card">
                                        <i class="fa fa-briefcase"/>
                                        <span class="count"><t t-esc="state.selectedJobIds.length"/></span>
                                        <span class="label">Jobs</span>
                                    </div>
                                    <div class="selection-card">
                                        <i class="fa fa-user-tie"/>
                                        <span class="count"><t t-esc="state.selectedInspectorIds.length"/></span>
                                        <span class="label">Inspectors</span>
                                    </div>
                                </div>
                                <t t-if="state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0">
                                    <div class="prereq-warning">
                                        <i class="fa fa-exclamation-triangle"/>
                                        <span>Go to <strong>Plan</strong> tab to select jobs and inspectors</span>
                                        <button class="btn btn-sm btn-outline-primary mt-2" t-on-click="onSetActiveTabPlan">
                                            <i class="fa fa-arrow-left me-1"/> Back to Plan
                                        </button>
                                    </div>
                                </t>
                            </div>

                            <!-- Optimization Progress -->
                            <t t-if="state.optimizationRunning">
                                <div class="sidebar-section optimization-progress">
                                    <div class="progress mb-3" style="height: 12px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                             role="progressbar"
                                             t-attf-style="width: {{ state.optimizationProgress }}%"/>
                                    </div>
                                    <div class="optimization-status text-center mb-3">
                                        <i class="fa fa-spinner fa-spin me-2 text-primary"/>
                                        <span class="fw-medium"><t t-esc="state.optimizationStatus"/></span>
                                    </div>
                                    <div class="time-stats">
                                        <div class="time-stat">
                                            <small>Elapsed</small>
                                            <strong><t t-esc="formatDuration(state.optimizationElapsed)"/></strong>
                                        </div>
                                        <div class="progress-badge">
                                            <t t-esc="state.optimizationProgress"/>%
                                        </div>
                                        <div class="time-stat text-end">
                                            <small>Remaining</small>
                                            <strong><t t-esc="formatDuration(Math.max(0, state.optimizationEstimate - state.optimizationElapsed))"/></strong>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Optimization Results -->
                            <t t-if="state.optimizationResult">
                                <div class="sidebar-section">
                                    <div class="section-header">
                                        <h6><i class="fa fa-check-circle text-success"/> Results</h6>
                                    </div>
                                    <div class="result-stats">
                                        <div class="stat-item">
                                            <span class="stat-value" t-esc="state.optimizationResult.routes_created || 0"/>
                                            <span class="stat-label">Routes</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-value" t-esc="state.optimizationResult.jobs_assigned || 0"/>
                                            <span class="stat-label">Jobs</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-value"><t t-esc="formatDistance(state.optimizationResult.total_distance)"/></span>
                                            <span class="stat-label">Distance</span>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Start Optimization Button -->
                            <div class="sidebar-footer">
                                <button type="button"
                                        t-attf-class="btn btn-primary btn-lg w-100 {{ optimizeButtonDisabled ? 'disabled-with-reason' : '' }}"
                                        t-att-disabled="optimizeButtonDisabled"
                                        t-on-click="startOptimization"
                                        t-att-title="state.selectedJobIds.length === 0 ? 'Select jobs first' : state.selectedInspectorIds.length === 0 ? 'Select inspectors first' : 'Run route optimization'">
                                    <t t-if="state.optimizationRunning">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"/>
                                        Optimizing...
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-play me-2"/> <t t-esc="optimizeButtonText"/>
                                    </t>
                                </button>
                            </div>
                        </t>

                        <!-- SCHEDULE Tab Content -->
                        <t t-if="state.activeTab === 'schedule'">
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-route"/> Routes for <t t-esc="state.selectedDate"/></h6>
                                </div>
                                <t t-if="state.routes.length === 0">
                                    <div class="empty-state-card">
                                        <div class="empty-state-illustration">
                                            <i class="fa fa-route primary"/>
                                            <i class="fa fa-map-marked-alt accent"/>
                                        </div>
                                        <h5>No routes scheduled</h5>
                                        <p>Create optimized routes by selecting jobs and inspectors in the Plan tab.</p>
                                        <button class="btn btn-sm btn-primary" t-on-click="onSetActiveTabPlan">
                                            <i class="fa fa-list-check me-1"/> Go to Plan
                                        </button>
                                        <div class="empty-state-steps">
                                            <div class="step"><span class="step-num">1</span> Select jobs to schedule</div>
                                            <div class="step"><span class="step-num">2</span> Choose available inspectors</div>
                                            <div class="step"><span class="step-num">3</span> Click "Optimize" to create routes</div>
                                        </div>
                                    </div>
                                </t>
                                <div class="route-list">
                                    <t t-foreach="state.routes" t-as="route" t-key="route.id">
                                        <div t-attf-class="route-item {{ state.selectedRouteId === route.id ? 'selected' : '' }}"
                                             t-on-click="() => this.selectRoute(route.id)">
                                            <div class="route-header">
                                                <span class="route-name" t-esc="route.name || route.route_number"/>
                                                <span t-attf-class="badge bg-{{ route.state === 'completed' ? 'success' : route.state === 'in_progress' ? 'primary' : 'secondary' }}" t-esc="route.state"/>
                                            </div>
                                            <div class="route-meta">
                                                <span><i class="fa fa-user"/> <t t-esc="route.inspector_id ? route.inspector_id[1] : 'Unassigned'"/></span>
                                                <span><i class="fa fa-tasks"/> <t t-esc="route.job_ids ? route.job_ids.length : 0"/> jobs</span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>

                <!-- MAP AREA (Takes remaining space) -->
                <div class="dispatch-map-area">
                    <!-- Map Container -->
                    <div class="dispatch-map-container">
                        <DispatchMapWidget
                            jobs="mapJobs"
                            routes="state.routes"
                            inspectors="state.inspectors"
                            selectedInspectorIds="state.selectedInspectorIds"
                            selectedJobIds="state.selectedJobIds"
                            hoveredJobId="state.hoveredJobId"
                            onJobClick="(job) => this.toggleJobSelection(job.id)"
                            onJobHover="(jobId) => this.onJobHover(jobId)"
                            dataVersion="mapJobs.length + '-' + state.routes.length + '-' + state.selectedJobIds.length + '-' + (state.hoveredJobId || 'none') + '-' + state.mapShowAll"/>
                    </div>

                    <!-- Loading Overlay -->
                    <div t-if="state.loading" class="dispatch-loading-overlay">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- Map Filter Toggle (GEMINI UX: Show All vs Show Listed) -->
                    <div class="map-filter-toggle">
                        <button t-attf-class="map-filter-btn {{ state.mapShowAll ? '' : 'active' }}"
                                t-on-click="() => this.setMapFilter(false)"
                                title="Show only jobs matching current filters">
                            <i class="fa fa-filter"/> Listed
                        </button>
                        <button t-attf-class="map-filter-btn {{ state.mapShowAll ? 'active' : '' }}"
                                t-on-click="() => this.setMapFilter(true)"
                                title="Show all jobs on map">
                            <i class="fa fa-globe"/> All
                        </button>
                    </div>

                    <!-- Map Legend (Bottom Right, Icon-only with hover expand) -->
                    <div class="map-legend-compact">
                        <button class="legend-icon-btn" title="Map Legend">
                            <i class="fa fa-layer-group"/>
                        </button>
                        <div class="legend-popup">
                            <div class="legend-section-title">Job Status</div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #3B82F6;"/>
                                <span>Unassigned <small>(standard)</small></span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker pulsing" style="background: #EF4444;"/>
                                <span>Urgent <small>(high priority)</small></span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #10B981;"/>
                                <span>Scheduled</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #8B5CF6;"/>
                                <span>Assigned to Inspector</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #0EA5E9;"/>
                                <span>In Progress</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #22C55E;"/>
                                <span>Completed</span>
                            </div>
                            <div class="legend-divider"/>
                            <div class="legend-section-title">Selection</div>
                            <div class="legend-item">
                                <span class="legend-marker selected-ring" style="background: #8B5CF6;"/>
                                <span>Selected Job</span>
                            </div>
                            <div class="legend-divider"/>
                            <div class="legend-section-title">Clusters</div>
                            <div class="legend-item">
                                <span class="legend-cluster"/>
                                <span>Grouped Jobs (click to expand)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Corner Empty State Notice (non-blocking) -->
                    <t t-if="state.jobs.length === 0 &amp;&amp; !state.loading">
                        <div class="empty-state-corner enhanced">
                            <div class="empty-corner-illustration">
                                <i class="fa fa-map-marker-alt"/>
                            </div>
                            <div class="empty-text">
                                <strong>Ready to schedule inspections</strong>
                                <span>Properties with due certifications will appear here as jobs</span>
                            </div>
                            <div class="empty-corner-actions">
                                <button type="button" class="btn btn-sm btn-primary" t-on-click="onGoToProperties">
                                    <i class="fa fa-building me-1"/> View Properties
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light" t-on-click="onLoadTestData">
                                    <i class="fa fa-flask me-1"/> Demo Data
                                </button>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- Timeline Panel (Bottom, only in Schedule tab) -->
                <t t-if="state.activeTab === 'schedule'">
                    <div class="dispatch-timeline-container">
                        <DispatchTimelineWidget
                            jobs="state.jobs"
                            routes="state.routes"
                            inspectors="state.inspectors"
                            date="state.selectedDate"/>
                    </div>
                </t>
            </div>
        </div>
    </t>
</templates>

