<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="property_fielder_field_service.EnhancedDispatchView">
        <div class="o_enhanced_dispatch_view">
            <!-- Top Navigation Bar -->
            <div class="dispatch-navbar">
                <div class="dispatch-brand">
                    <i class="fa fa-map-marked-alt" title="Dispatch"/>
                    <span>Dispatch</span>
                </div>

                <!-- Date Navigation (Prominent, Center-Left) -->
                <div class="dispatch-date-nav">
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onPrevDay" title="Previous Day">
                        <i class="fa fa-chevron-left"/>
                    </button>
                    <div class="date-display">
                        <input type="date"
                               class="form-control form-control-sm date-input"
                               t-att-value="state.selectedDate"
                               t-on-change="onDateChange"/>
                        <button type="button" class="btn btn-sm btn-today" t-on-click="onToday" title="Go to Today">
                            Today
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onNextDay" title="Next Day">
                        <i class="fa fa-chevron-right"/>
                    </button>
                </div>

                <!-- Tab Navigation (Consistent Styling) -->
                <div class="dispatch-tabs">
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'plan' ? 'active' : '' }}"
                            t-on-click="onSetActiveTabPlan">
                        <i class="fa fa-list-check" title="Plan"/> Plan
                    </button>
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'optimize' ? 'active' : '' }} {{ !canAccessOptimize() ? 'disabled' : '' }}"
                            t-on-click="onSetActiveTabOptimize"
                            t-att-title="!canAccessOptimize() ? 'Select jobs and inspectors first' : 'Optimize routes'">
                        <i class="fa fa-magic"/> Optimize
                        <span class="tab-prereq-badge" t-if="!canAccessOptimize()">
                            <i class="fa fa-lock"/>
                        </span>
                    </button>
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'schedule' ? 'active' : '' }} {{ !canAccessSchedule() ? 'disabled' : '' }}"
                            t-on-click="onSetActiveTabSchedule"
                            t-att-title="!canAccessSchedule() ? 'Run optimization first' : 'View schedule'">
                        <i class="fa fa-calendar-check"/> Schedule
                        <span class="tab-prereq-badge" t-if="!canAccessSchedule()">
                            <i class="fa fa-lock"/>
                        </span>
                    </button>
                </div>

                <!-- Controls -->
                <div class="dispatch-controls">
                    <button type="button" class="btn btn-sm btn-icon-refresh" t-on-click="onRefresh" title="Refresh data">
                        <i class="fa fa-sync"/>
                    </button>

                    <!-- Test Data Dropdown (Subtle, Ghost Button Style) -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-ghost dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false" title="Test Data for Demo">
                            <i class="fa fa-flask"/>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Demo Test Data</li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click.prevent="onLoadTestData">
                                    <i class="fa fa-plus text-success me-2"/> Load 20 Test Jobs
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" t-on-click.prevent="onDeleteTestData">
                                    <i class="fa fa-trash me-2"/> Delete All Test Data
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content Area - CSS Grid Layout -->
            <div t-attf-class="dispatch-content {{ state.sidebarCollapsed ? 'sidebar-collapsed' : '' }}">
                <!-- Expand button (visible when sidebar collapsed) -->
                <button class="sidebar-expand-button" t-on-click="toggleSidebar" title="Expand sidebar">
                    <i class="fa fa-chevron-right"/>
                </button>

                <!-- DOCKED SIDEBAR (Slides in/out) -->
                <div class="dispatch-sidebar">
                    <!-- Sidebar Header with Toggle -->
                    <div class="sidebar-header">
                        <span class="sidebar-title">
                            <i t-if="state.activeTab === 'plan'" class="fa fa-list-check"/>
                            <i t-if="state.activeTab === 'optimize'" class="fa fa-magic"/>
                            <i t-if="state.activeTab === 'schedule'" class="fa fa-calendar-check"/>
                            <t t-if="state.activeTab === 'plan'">Plan Resources</t>
                            <t t-if="state.activeTab === 'optimize'">Optimize Routes</t>
                            <t t-if="state.activeTab === 'schedule'">Schedule View</t>
                        </span>
                        <button class="btn btn-sm btn-sidebar-collapse" t-on-click="toggleSidebar" t-att-title="state.sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                            <i t-attf-class="fa fa-chevron-{{ state.sidebarCollapsed ? 'right' : 'left' }}"/>
                        </button>
                    </div>

                    <!-- Sidebar Content (scrollable) -->
                    <div class="sidebar-content" t-if="!state.sidebarCollapsed">
                        <!-- PLAN Tab Content -->
                        <t t-if="state.activeTab === 'plan'">
                            <!-- Jobs Section -->
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-briefcase"/> Jobs (<t t-esc="filteredJobs.length"/>/<t t-esc="state.jobs.length"/>)</h6>
                                    <div class="section-actions">
                                        <button class="btn btn-xs btn-outline-primary" t-on-click="selectAllJobs">Select All</button>
                                        <button class="btn btn-xs btn-outline-secondary" t-on-click="clearJobSelection">Clear</button>
                                    </div>
                                </div>
                                <!-- Search Filter -->
                                <div class="search-filter">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fa fa-search"/></span>
                                        <input type="text" class="form-control" placeholder="Search jobs..."
                                               t-att-value="state.jobSearchQuery"
                                               t-on-input="onJobSearchInput"/>
                                        <button class="btn btn-outline-secondary" type="button" t-on-click="clearJobSearch"
                                                t-if="state.jobSearchQuery">
                                            <i class="fa fa-times"/>
                                        </button>
                                    </div>
                                </div>
                                <div class="resource-list">
                                    <t t-foreach="filteredJobs" t-as="job" t-key="job.id">
                                        <div t-attf-class="resource-item job-item {{ state.selectedJobIds.includes(job.id) ? 'selected' : '' }} {{ state.hoveredJobId === job.id ? 'hovered' : '' }}"
                                             t-on-click="() => this.toggleJobSelection(job.id)"
                                             t-on-mouseenter="() => this.onJobHover(job.id)"
                                             t-on-mouseleave="() => this.onJobHover(null)">
                                            <div class="job-item-main">
                                                <input type="checkbox" t-att-checked="state.selectedJobIds.includes(job.id)"/>
                                                <span class="resource-name" t-esc="job.name || job.job_number"/>
                                                <span t-attf-class="resource-status badge badge-{{ job.state }}" t-esc="job.state"/>
                                            </div>
                                            <div class="job-item-times">
                                                <span class="job-deadline" t-if="job.latest_end" t-att-title="'Deadline: ' + job.latest_end">
                                                    ‚è∞ <t t-esc="formatTime(job.latest_end)"/>
                                                </span>
                                                <span class="job-scheduled" t-if="job.scheduled_arrival_time" t-att-title="'Scheduled: ' + job.scheduled_arrival_time">
                                                    üìÖ <t t-esc="formatTime(job.scheduled_arrival_time)"/>
                                                </span>
                                            </div>
                                        </div>
                                    </t>
                                    <!-- Empty state for jobs -->
                                    <t t-if="state.jobs.length === 0">
                                        <div class="empty-list-notice">
                                            <i class="fa fa-inbox"/>
                                            <span>No jobs for this date</span>
                                        </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Inspectors Section -->
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-user-tie"/> Inspectors (<t t-esc="state.inspectors.length"/>)</h6>
                                    <div class="section-actions">
                                        <button class="btn btn-xs btn-outline-primary" t-on-click="selectAllInspectors">Select All</button>
                                        <button class="btn btn-xs btn-outline-secondary" t-on-click="clearInspectorSelection">Clear</button>
                                    </div>
                                </div>
                                <div class="resource-list">
                                    <t t-foreach="state.inspectors" t-as="inspector" t-key="inspector.id">
                                        <div t-attf-class="resource-item {{ state.selectedInspectorIds.includes(inspector.id) ? 'selected' : '' }} {{ !inspector.available ? 'unavailable' : '' }}"
                                             t-on-click="() => this.toggleInspectorSelection(inspector.id)">
                                            <input type="checkbox" t-att-checked="state.selectedInspectorIds.includes(inspector.id)"/>
                                            <span class="resource-name" t-esc="inspector.name"/>
                                            <span t-if="!inspector.available" class="badge bg-secondary">Unavailable</span>
                                        </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Optimization Settings (collapsed by default) -->
                            <div class="sidebar-section collapsible">
                                <div class="section-header clickable" t-on-click="toggleSettingsSection">
                                    <h6><i class="fa fa-cog"/> Settings</h6>
                                    <i t-attf-class="fa fa-chevron-{{ state.settingsExpanded ? 'up' : 'down' }}"/>
                                </div>
                                <div class="section-body" t-if="state.settingsExpanded">
                                    <div class="setting-group">
                                        <label class="form-label">Solver Time Limit</label>
                                        <select class="form-select form-select-sm">
                                            <option value="30">30 seconds</option>
                                            <option value="60" selected="">1 minute</option>
                                            <option value="180">3 minutes</option>
                                            <option value="300">5 minutes</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label class="form-label">Optimization Mode</label>
                                        <select class="form-select form-select-sm">
                                            <option value="balanced">Balanced</option>
                                            <option value="minimize_distance">Minimize Distance</option>
                                            <option value="minimize_time">Minimize Time</option>
                                            <option value="maximize_jobs">Maximize Jobs</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="useOsrm" checked=""/>
                                            <label class="form-check-label" for="useOsrm">Use OSRM for routing</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="respectTimeWindows" checked=""/>
                                            <label class="form-check-label" for="respectTimeWindows">Respect time windows</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Optimize Button (always visible in Plan tab) -->
                            <div class="sidebar-footer">
                                <button type="button"
                                        t-attf-class="btn btn-primary btn-lg w-100 {{ optimizeButtonDisabled ? 'disabled-with-reason' : '' }}"
                                        t-att-disabled="optimizeButtonDisabled"
                                        t-on-click="startOptimization"
                                        t-att-title="state.selectedJobIds.length === 0 ? 'Select jobs first' : state.selectedInspectorIds.length === 0 ? 'Select inspectors first' : 'Run route optimization'">
                                    <t t-if="state.optimizationRunning">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"/>
                                        Optimizing...
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-magic me-2"/> <t t-esc="optimizeButtonText"/>
                                    </t>
                                </button>
                                <div class="selection-summary" t-if="state.selectedJobIds.length > 0 || state.selectedInspectorIds.length > 0">
                                    <span><t t-esc="state.selectedJobIds.length"/> jobs</span>
                                    <span class="separator">‚Ä¢</span>
                                    <span><t t-esc="state.selectedInspectorIds.length"/> inspectors</span>
                                </div>
                                <div class="prereq-hint" t-if="state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0">
                                    <i class="fa fa-info-circle"/>
                                    <t t-if="state.selectedJobIds.length === 0 &amp;&amp; state.selectedInspectorIds.length === 0">
                                        Select jobs and inspectors to optimize
                                    </t>
                                    <t t-elif="state.selectedJobIds.length === 0">
                                        Select at least one job
                                    </t>
                                    <t t-else="">
                                        Select at least one inspector
                                    </t>
                                </div>
                            </div>
                        </t>

                        <!-- OPTIMIZE Tab Content -->
                        <t t-if="state.activeTab === 'optimize'">
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-check-circle"/> Selected Resources</h6>
                                </div>
                                <div class="selection-cards">
                                    <div class="selection-card">
                                        <i class="fa fa-briefcase"/>
                                        <span class="count"><t t-esc="state.selectedJobIds.length"/></span>
                                        <span class="label">Jobs</span>
                                    </div>
                                    <div class="selection-card">
                                        <i class="fa fa-user-tie"/>
                                        <span class="count"><t t-esc="state.selectedInspectorIds.length"/></span>
                                        <span class="label">Inspectors</span>
                                    </div>
                                </div>
                                <t t-if="state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0">
                                    <div class="prereq-warning">
                                        <i class="fa fa-exclamation-triangle"/>
                                        <span>Go to <strong>Plan</strong> tab to select jobs and inspectors</span>
                                        <button class="btn btn-sm btn-outline-primary mt-2" t-on-click="onSetActiveTabPlan">
                                            <i class="fa fa-arrow-left me-1"/> Back to Plan
                                        </button>
                                    </div>
                                </t>
                            </div>

                            <!-- Optimization Progress -->
                            <t t-if="state.optimizationRunning">
                                <div class="sidebar-section optimization-progress">
                                    <div class="progress mb-3" style="height: 12px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                             role="progressbar"
                                             t-attf-style="width: {{ state.optimizationProgress }}%"/>
                                    </div>
                                    <div class="optimization-status text-center mb-3">
                                        <i class="fa fa-spinner fa-spin me-2 text-primary"/>
                                        <span class="fw-medium"><t t-esc="state.optimizationStatus"/></span>
                                    </div>
                                    <div class="time-stats">
                                        <div class="time-stat">
                                            <small>Elapsed</small>
                                            <strong><t t-esc="formatDuration(state.optimizationElapsed)"/></strong>
                                        </div>
                                        <div class="progress-badge">
                                            <t t-esc="state.optimizationProgress"/>%
                                        </div>
                                        <div class="time-stat text-end">
                                            <small>Remaining</small>
                                            <strong><t t-esc="formatDuration(Math.max(0, state.optimizationEstimate - state.optimizationElapsed))"/></strong>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Optimization Results -->
                            <t t-if="state.optimizationResult">
                                <div class="sidebar-section">
                                    <div class="section-header">
                                        <h6><i class="fa fa-check-circle text-success"/> Results</h6>
                                    </div>
                                    <div class="result-stats">
                                        <div class="stat-item">
                                            <span class="stat-value" t-esc="state.optimizationResult.routes_created || 0"/>
                                            <span class="stat-label">Routes</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-value" t-esc="state.optimizationResult.jobs_assigned || 0"/>
                                            <span class="stat-label">Jobs</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-value"><t t-esc="formatDistance(state.optimizationResult.total_distance)"/></span>
                                            <span class="stat-label">Distance</span>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Start Optimization Button -->
                            <div class="sidebar-footer">
                                <button type="button"
                                        t-attf-class="btn btn-primary btn-lg w-100 {{ optimizeButtonDisabled ? 'disabled-with-reason' : '' }}"
                                        t-att-disabled="optimizeButtonDisabled"
                                        t-on-click="startOptimization"
                                        t-att-title="state.selectedJobIds.length === 0 ? 'Select jobs first' : state.selectedInspectorIds.length === 0 ? 'Select inspectors first' : 'Run route optimization'">
                                    <t t-if="state.optimizationRunning">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"/>
                                        Optimizing...
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-play me-2"/> <t t-esc="optimizeButtonText"/>
                                    </t>
                                </button>
                            </div>
                        </t>

                        <!-- SCHEDULE Tab Content -->
                        <t t-if="state.activeTab === 'schedule'">
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <h6><i class="fa fa-route"/> Routes for <t t-esc="state.selectedDate"/></h6>
                                </div>
                                <t t-if="state.routes.length === 0">
                                    <div class="empty-list-notice">
                                        <i class="fa fa-route"/>
                                        <span>No routes for this date</span>
                                        <button class="btn btn-sm btn-outline-primary mt-2" t-on-click="onSetActiveTabPlan">
                                            <i class="fa fa-magic me-1"/> Create Routes
                                        </button>
                                    </div>
                                </t>
                                <div class="route-list">
                                    <t t-foreach="state.routes" t-as="route" t-key="route.id">
                                        <div t-attf-class="route-item {{ state.selectedRouteId === route.id ? 'selected' : '' }}"
                                             t-on-click="() => this.selectRoute(route.id)">
                                            <div class="route-header">
                                                <span class="route-name" t-esc="route.name || route.route_number"/>
                                                <span t-attf-class="badge bg-{{ route.state === 'completed' ? 'success' : route.state === 'in_progress' ? 'primary' : 'secondary' }}" t-esc="route.state"/>
                                            </div>
                                            <div class="route-meta">
                                                <span><i class="fa fa-user"/> <t t-esc="route.inspector_id ? route.inspector_id[1] : 'Unassigned'"/></span>
                                                <span><i class="fa fa-tasks"/> <t t-esc="route.job_ids ? route.job_ids.length : 0"/> jobs</span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>

                <!-- MAP AREA (Takes remaining space) -->
                <div class="dispatch-map-area">
                    <!-- Map Container -->
                    <div class="dispatch-map-container">
                        <DispatchMapWidget
                            jobs="state.jobs"
                            routes="state.routes"
                            inspectors="state.inspectors"
                            selectedInspectorIds="state.selectedInspectorIds"
                            hoveredJobId="state.hoveredJobId"
                            dataVersion="state.jobs.length + '-' + state.routes.length + '-' + (state.hoveredJobId || 'none')"/>
                    </div>

                    <!-- Loading Overlay -->
                    <div t-if="state.loading" class="dispatch-loading-overlay">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- Map Legend (Bottom Right, Collapsible) -->
                    <div t-attf-class="map-legend {{ state.legendCollapsed ? 'collapsed' : '' }}">
                        <div class="map-legend-header" t-on-click="toggleLegend">
                            <i class="fa fa-info-circle"/> Legend
                            <i t-attf-class="fa fa-chevron-{{ state.legendCollapsed ? 'up' : 'down' }} legend-toggle"/>
                        </div>
                        <div class="map-legend-body" t-if="!state.legendCollapsed">
                            <div class="legend-section-title">Job Status</div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #8B5CF6; border: 2px solid #fff;"/>
                                <span>Draft (Unscheduled)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #17a2b8;"/>
                                <span>Scheduled</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #ffc107;"/>
                                <span>Assigned</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #007bff;"/>
                                <span>In Progress</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-marker" style="background: #28a745;"/>
                                <span>Completed</span>
                            </div>
                            <div class="legend-divider"/>
                            <div class="legend-section-title">Map Symbols</div>
                            <div class="legend-item">
                                <span class="legend-cluster"/>
                                <span>Cluster (# jobs)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Corner Empty State Notice (non-blocking) -->
                    <t t-if="state.jobs.length === 0 &amp;&amp; !state.loading">
                        <div class="empty-state-corner">
                            <i class="fa fa-calendar-plus"/>
                            <div class="empty-text">
                                <strong>No jobs for <t t-esc="state.selectedDate"/></strong>
                                <span>Load test data or create jobs from properties</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" t-on-click="onGoToProperties">
                                <i class="fa fa-building me-1"/> Create Jobs
                            </button>
                        </div>
                    </t>
                </div>

                <!-- Timeline Panel (Bottom, only in Schedule tab) -->
                <t t-if="state.activeTab === 'schedule'">
                    <div class="dispatch-timeline-container">
                        <DispatchTimelineWidget
                            jobs="state.jobs"
                            routes="state.routes"
                            inspectors="state.inspectors"
                            date="state.selectedDate"/>
                    </div>
                </t>
            </div>
        </div>
    </t>
</templates>

