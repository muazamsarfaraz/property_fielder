<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="property_fielder_field_service.EnhancedDispatchView">
        <div class="o_enhanced_dispatch_view">
            <!-- Top Navigation Bar -->
            <div class="dispatch-navbar">
                <div class="dispatch-brand">
                    <i class="fa fa-map-marked-alt" title="Dispatch"/>
                    <span>Dispatch</span>
                </div>

                <!-- Date Navigation (Prominent, Center-Left) -->
                <div class="dispatch-date-nav">
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onPrevDay" title="Previous Day">
                        <i class="fa fa-chevron-left"/>
                    </button>
                    <div class="date-display">
                        <input type="date"
                               class="form-control form-control-sm date-input"
                               t-att-value="state.selectedDate"
                               t-on-change="onDateChange"/>
                        <button type="button" class="btn btn-sm btn-today" t-on-click="onToday" title="Go to Today">
                            Today
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-date-nav" t-on-click="onNextDay" title="Next Day">
                        <i class="fa fa-chevron-right"/>
                    </button>
                </div>

                <!-- Tab Navigation (Consistent Styling) -->
                <div class="dispatch-tabs">
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'plan' ? 'active' : '' }}"
                            t-on-click="onSetActiveTabPlan">
                        <i class="fa fa-list-check" title="Plan"/> Plan
                    </button>
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'optimize' ? 'active' : '' }}"
                            t-on-click="onSetActiveTabOptimize">
                        <i class="fa fa-magic" title="Optimize"/> Optimize
                    </button>
                    <button type="button"
                            t-attf-class="dispatch-tab {{ state.activeTab === 'schedule' ? 'active' : '' }}"
                            t-on-click="onSetActiveTabSchedule">
                        <i class="fa fa-calendar-check" title="Schedule"/> Schedule
                    </button>
                </div>

                <!-- Controls -->
                <div class="dispatch-controls">
                    <button type="button" class="btn btn-sm btn-icon-refresh" t-on-click="onRefresh" title="Refresh data">
                        <i class="fa fa-sync"/>
                    </button>

                    <!-- Test Data Dropdown (Subtle, Ghost Button Style) -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-ghost dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false" title="Test Data for Demo">
                            <i class="fa fa-flask"/>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Demo Test Data</li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click.prevent="onLoadTestData">
                                    <i class="fa fa-plus text-success me-2"/> Load 20 Test Jobs
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" t-on-click.prevent="onDeleteTestData">
                                    <i class="fa fa-trash me-2"/> Delete All Test Data
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="dispatch-content">
                <!-- Persistent Map (Always Visible) -->
                <div class="dispatch-map-container">
                    <DispatchMapWidget
                        jobs="state.jobs"
                        routes="state.routes"
                        inspectors="state.inspectors"
                        dataVersion="state.jobs.length + '-' + state.routes.length"/>
                </div>

                <!-- Loading Overlay -->
                <div t-if="state.loading" class="dispatch-loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Map Legend (Bottom Right, Collapsible) -->
                <div t-attf-class="map-legend {{ state.legendCollapsed ? 'collapsed' : '' }}">
                    <div class="map-legend-header" t-on-click="toggleLegend">
                        <i class="fa fa-info-circle"/> Legend
                        <i t-attf-class="fa fa-chevron-{{ state.legendCollapsed ? 'up' : 'down' }} legend-toggle"/>
                    </div>
                    <div class="map-legend-body" t-if="!state.legendCollapsed">
                        <div class="legend-section-title">Job Status</div>
                        <div class="legend-item">
                            <span class="legend-marker" style="background: #8B5CF6; border: 2px solid #fff;"/>
                            <span>Draft (Unscheduled)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker" style="background: #17a2b8;"/>
                            <span>Scheduled</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker" style="background: #ffc107;"/>
                            <span>Assigned</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker" style="background: #007bff;"/>
                            <span>In Progress</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker" style="background: #28a745;"/>
                            <span>Completed</span>
                        </div>
                        <div class="legend-divider"/>
                        <div class="legend-section-title">Map Symbols</div>
                        <div class="legend-item">
                            <span class="legend-cluster"/>
                            <span>Cluster (# jobs)</span>
                        </div>
                    </div>
                </div>

                <!-- PLAN Tab Panels -->
                <t t-if="state.activeTab === 'plan'">
                    <!-- Resources Panel -->
                    <div t-if="state.panels.resources" class="floating-panel" style="left: 20px; top: 80px; width: 320px;">
                        <div class="floating-panel-header">
                            <i class="fa fa-users" title="Resources"/>
                            <span>Resources</span>
                            <button class="btn btn-sm btn-link" t-on-click="() => togglePanel('resources')">
                                <i class="fa fa-times" title="Close"/>
                            </button>
                        </div>
                        <div class="floating-panel-body">
                            <div class="panel-section">
                                <h6><i class="fa fa-briefcase" title="Jobs"/> Jobs (<t t-esc="state.jobs.length"/>)</h6>
                                <div class="d-flex gap-1 mb-2">
                                    <button class="btn btn-xs btn-outline-primary" t-on-click="selectAllJobs">Select All</button>
                                    <button class="btn btn-xs btn-outline-secondary" t-on-click="clearJobSelection">Clear</button>
                                </div>
                                <div class="resource-list">
                                    <t t-foreach="state.jobs" t-as="job" t-key="job.id">
                                        <div t-attf-class="resource-item job-item {{ state.selectedJobIds.includes(job.id) ? 'selected' : '' }}"
                                             t-on-click="() => toggleJobSelection(job.id)">
                                            <div class="job-item-main">
                                                <input type="checkbox" t-att-checked="state.selectedJobIds.includes(job.id)"/>
                                                <span class="resource-name" t-esc="job.name || job.job_number"/>
                                                <span t-attf-class="resource-status badge badge-{{ job.state }}" t-esc="job.state"/>
                                            </div>
                                            <div class="job-item-times">
                                                <span class="job-deadline" t-if="job.latest_end" t-att-title="'Deadline: ' + job.latest_end">
                                                    ‚è∞ <t t-esc="formatTime(job.latest_end)"/>
                                                </span>
                                                <span class="job-scheduled" t-if="job.scheduled_arrival_time" t-att-title="'Scheduled: ' + job.scheduled_arrival_time">
                                                    üìÖ <t t-esc="formatTime(job.scheduled_arrival_time)"/>
                                                </span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                            <div class="panel-section">
                                <h6><i class="fa fa-user-tie" title="Inspectors"/> Inspectors (<t t-esc="state.inspectors.length"/>)</h6>
                                <div class="d-flex gap-1 mb-2">
                                    <button class="btn btn-xs btn-outline-primary" t-on-click="selectAllInspectors">Select All</button>
                                    <button class="btn btn-xs btn-outline-secondary" t-on-click="clearInspectorSelection">Clear</button>
                                </div>
                                <div class="resource-list">
                                    <t t-foreach="state.inspectors" t-as="inspector" t-key="inspector.id">
                                        <div t-attf-class="resource-item {{ state.selectedInspectorIds.includes(inspector.id) ? 'selected' : '' }} {{ !inspector.available ? 'unavailable' : '' }}"
                                             t-on-click="() => toggleInspectorSelection(inspector.id)">
                                            <input type="checkbox" t-att-checked="state.selectedInspectorIds.includes(inspector.id)"/>
                                            <span class="resource-name" t-esc="inspector.name"/>
                                            <span t-if="!inspector.available" class="badge bg-secondary">Unavailable</span>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Panel -->
                    <div t-if="state.panels.settings" class="floating-panel" style="left: 360px; top: 80px; width: 300px;">
                        <div class="floating-panel-header">
                            <i class="fa fa-cog" title="Settings"/>
                            <span>Optimization Settings</span>
                            <button class="btn btn-sm btn-link" t-on-click="() => togglePanel('settings')">
                                <i class="fa fa-times" title="Close"/>
                            </button>
                        </div>
                        <div class="floating-panel-body">
                            <div class="panel-section">
                                <label class="form-label">Solver Time Limit</label>
                                <select class="form-select form-select-sm">
                                    <option value="30">30 seconds</option>
                                    <option value="60" selected="">1 minute</option>
                                    <option value="180">3 minutes</option>
                                    <option value="300">5 minutes</option>
                                </select>
                            </div>
                            <div class="panel-section">
                                <label class="form-label">Optimization Mode</label>
                                <select class="form-select form-select-sm">
                                    <option value="balanced">Balanced</option>
                                    <option value="minimize_distance">Minimize Distance</option>
                                    <option value="minimize_time">Minimize Time</option>
                                    <option value="maximize_jobs">Maximize Jobs</option>
                                </select>
                            </div>
                            <div class="panel-section">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="useOsrm" checked=""/>
                                    <label class="form-check-label" for="useOsrm">Use OSRM for routing</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="respectTimeWindows" checked=""/>
                                    <label class="form-check-label" for="respectTimeWindows">Respect time windows</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- OPTIMIZE Tab Panels -->
                <t t-if="state.activeTab === 'optimize'">
                    <div t-if="state.panels.optimization" class="floating-panel" style="left: 20px; top: 80px; width: 380px;">
                        <div class="floating-panel-header">
                            <i class="fa fa-magic" title="Optimization"/>
                            <span>Optimization Control</span>
                            <button class="btn btn-sm btn-link" t-on-click="() => togglePanel('optimization')">
                                <i class="fa fa-times" title="Close"/>
                            </button>
                        </div>
                        <div class="floating-panel-body">
                            <div class="panel-section">
                                <h6>Selected Resources</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span><i class="fa fa-briefcase" title="Jobs"/> <t t-esc="state.selectedJobIds.length"/> jobs</span>
                                    <span><i class="fa fa-user-tie" title="Inspectors"/> <t t-esc="state.selectedInspectorIds.length"/> inspectors</span>
                                </div>
                                <t t-if="state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0">
                                    <div class="alert alert-warning">
                                        <i class="fa fa-exclamation-triangle" title="Warning"/>
                                        Go to PLAN tab to select jobs and inspectors first.
                                    </div>
                                </t>
                            </div>

                            <div class="panel-section">
                                <button type="button"
                                        class="btn btn-primary btn-lg w-100"
                                        t-att-disabled="state.optimizationRunning || state.selectedJobIds.length === 0 || state.selectedInspectorIds.length === 0"
                                        t-on-click="startOptimization">
                                    <t t-if="state.optimizationRunning">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"/>
                                        Optimizing...
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-play me-2" title="Start"/> Start Optimization
                                    </t>
                                </button>
                            </div>

                            <t t-if="state.optimizationRunning">
                                <div class="panel-section optimization-progress">
                                    <!-- Progress bar -->
                                    <div class="progress mb-2" style="height: 10px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                             role="progressbar"
                                             t-attf-style="width: {{ state.optimizationProgress }}%"
                                             t-att-aria-valuenow="state.optimizationProgress"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                        </div>
                                    </div>

                                    <!-- Status message -->
                                    <div class="optimization-status text-center mb-2">
                                        <i class="fa fa-spinner fa-spin me-1 text-primary"/>
                                        <span class="fw-medium"><t t-esc="state.optimizationStatus"/></span>
                                    </div>

                                    <!-- Time info -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="time-stat">
                                            <small class="text-muted">Elapsed</small>
                                            <div class="fw-bold">
                                                <t t-esc="formatTime(state.optimizationElapsed)"/>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <span class="badge bg-primary fs-6">
                                                <t t-esc="state.optimizationProgress"/>%
                                            </span>
                                        </div>
                                        <div class="time-stat text-end">
                                            <small class="text-muted">Est. Remaining</small>
                                            <div class="fw-bold">
                                                <t t-set="remaining" t-value="Math.max(0, state.optimizationEstimate - state.optimizationElapsed)"/>
                                                <t t-esc="formatTime(remaining)"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <t t-if="state.optimizationResult">
                                <div class="panel-section">
                                    <h6><i class="fa fa-check-circle text-success" title="Success"/> Optimization Results</h6>
                                    <div class="result-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Routes Created</span>
                                            <span class="stat-value" t-esc="state.optimizationResult.routes_created || 0"/>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Jobs Assigned</span>
                                            <span class="stat-value" t-esc="state.optimizationResult.jobs_assigned || 0"/>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Total Distance</span>
                                            <span class="stat-value"><t t-esc="state.optimizationResult.total_distance || 0"/> km</span>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                </t>

                <!-- SCHEDULE Tab Panels -->
                <t t-if="state.activeTab === 'schedule'">
                    <!-- Route Details Panel -->
                    <div t-if="state.panels.routeDetails" class="floating-panel" style="left: 20px; top: 80px; width: 400px;">
                        <div class="floating-panel-header">
                            <i class="fa fa-route" title="Routes"/>
                            <span>Routes &amp; Schedule</span>
                            <button class="btn btn-sm btn-link" t-on-click="() => togglePanel('routeDetails')">
                                <i class="fa fa-times" title="Close"/>
                            </button>
                        </div>
                        <div class="floating-panel-body">
                            <div class="panel-section">
                                <h6>Routes for <t t-esc="state.selectedDate"/></h6>
                                <t t-if="state.routes.length === 0">
                                    <div class="alert alert-info">
                                        <i class="fa fa-info-circle" title="Info"/>
                                        No routes for this date. Run optimization first.
                                    </div>
                                </t>
                                <div class="route-list">
                                    <t t-foreach="state.routes" t-as="route" t-key="route.id">
                                        <div t-attf-class="route-item {{ state.selectedRouteId === route.id ? 'selected' : '' }}"
                                             t-on-click="() => selectRoute(route.id)">
                                            <div class="route-header">
                                                <span class="route-name" t-esc="route.name || route.route_number"/>
                                                <span t-attf-class="badge bg-{{ route.state === 'completed' ? 'success' : route.state === 'in_progress' ? 'primary' : 'secondary' }}" t-esc="route.state"/>
                                            </div>
                                            <div class="route-meta">
                                                <span><i class="fa fa-user" title="Inspector"/> <t t-esc="route.inspector_id ? route.inspector_id[1] : 'Unassigned'"/></span>
                                                <span><i class="fa fa-tasks" title="Jobs"/> <t t-esc="route.job_ids ? route.job_ids.length : 0"/> jobs</span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Panel (Bottom) -->
                    <div class="dispatch-timeline-container">
                        <DispatchTimelineWidget
                            jobs="state.jobs"
                            routes="state.routes"
                            inspectors="state.inspectors"
                            date="state.selectedDate"/>
                    </div>
                </t>

                <!-- Empty State -->
                <t t-if="state.jobs.length === 0 &amp;&amp; !state.loading">
                    <div class="dispatch-empty-state">
                        <div class="empty-state-content">
                            <i class="fa fa-calendar-plus fa-4x text-muted mb-3" title="No jobs"/>
                            <h4>No Jobs Scheduled</h4>
                            <p class="text-muted">There are no jobs scheduled for <t t-esc="state.selectedDate"/>.</p>
                            <button type="button" class="btn btn-primary" t-on-click="onGoToProperties">
                                <i class="fa fa-building me-2" title="Properties"/> Create Jobs from Properties
                            </button>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>
</templates>

