<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Defect List View -->
    <record id="view_defect_list" model="ir.ui.view">
        <field name="name">property_fielder.defect.list</field>
        <field name="model">property_fielder.defect</field>
        <field name="arch" type="xml">
            <list decoration-danger="is_breached" decoration-warning="state == 'reported'" multi_edit="1">
                <field name="name"/>
                <field name="property_id"/>
                <field name="defect_type" widget="badge"/>
                <field name="fault_code_id" optional="show"/>
                <field name="severity_sla" widget="badge" decoration-danger="severity_sla == 'immediate'" decoration-warning="severity_sla == 'urgent'" decoration-info="severity_sla == 'standard'"/>
                <field name="description" optional="hide"/>
                <field name="reported_date"/>
                <field name="deadline_date"/>
                <field name="is_breached" invisible="1"/>
                <field name="days_overdue" optional="show"/>
                <field name="assigned_contractor_id" optional="show"/>
                <field name="state" widget="badge" decoration-info="state == 'reported'" decoration-warning="state in ['acknowledged', 'in_progress']" decoration-success="state in ['fixed', 'verified', 'closed']"/>
            </list>
        </field>
    </record>
    
    <!-- Defect Kanban View -->
    <record id="view_defect_kanban" model="ir.ui.view">
        <field name="name">property_fielder.defect.kanban</field>
        <field name="model">property_fielder.defect</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="name"/>
                <field name="property_id"/>
                <field name="severity_sla"/>
                <field name="deadline_date"/>
                <field name="is_breached"/>
                <field name="photo_count"/>
                <templates>
                    <t t-name="card">
                        <div t-attf-class="#{record.is_breached.raw_value ? 'border-danger' : ''}">
                            <field name="name" class="fw-bold"/>
                            <field name="property_id"/>
                            <div class="d-flex justify-content-between mt-2">
                                <field name="severity_sla" widget="badge"/>
                                <span t-if="record.photo_count.raw_value > 0">
                                    <i class="fa fa-camera"/> <t t-esc="record.photo_count.raw_value"/>
                                </span>
                            </div>
                            <div class="text-muted small mt-1">
                                Due: <field name="deadline_date"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- Defect Form View -->
    <record id="view_defect_form" model="ir.ui.view">
        <field name="name">property_fielder.defect.form</field>
        <field name="model">property_fielder.defect</field>
        <field name="arch" type="xml">
            <form string="Defect">
                <header>
                    <button name="action_acknowledge" string="Acknowledge" type="object" class="btn-primary" invisible="state != 'reported'"/>
                    <button name="action_start_work" string="Start Work" type="object" class="btn-primary" invisible="state != 'acknowledged'"/>
                    <button name="action_mark_fixed" string="Mark Fixed" type="object" class="btn-primary" invisible="state != 'in_progress'"/>
                    <button name="action_verify" string="Verify" type="object" class="btn-primary" invisible="state != 'fixed'"/>
                    <button name="action_close" string="Close" type="object" class="btn-secondary" invisible="state != 'verified'"/>
                    <button name="action_schedule_recheck" string="Schedule Re-check" type="object" class="btn-secondary" invisible="state not in ['fixed', 'verified']"/>
                    <field name="state" widget="statusbar" statusbar_visible="reported,acknowledged,in_progress,fixed,verified,closed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_photos" type="object" class="oe_stat_button" icon="fa-camera">
                            <field name="photo_count" widget="statinfo" string="Photos"/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="SLA Breached" bg_color="text-bg-danger" invisible="not is_breached"/>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Classification">
                            <field name="defect_type"/>
                            <field name="property_id"/>
                            <field name="location"/>
                            <field name="fault_code_id" invisible="defect_type != 'regulatory_fault'"/>
                            <field name="hhsrs_hazard_type_id" invisible="defect_type != 'hhsrs_hazard'"/>
                            <field name="hhsrs_band" invisible="defect_type != 'hhsrs_hazard'"/>
                            <field name="severity_sla"/>
                        </group>
                        <group string="Dates &amp; SLA">
                            <field name="reported_date"/>
                            <field name="deadline_date"/>
                            <field name="is_breached" invisible="1"/>
                            <field name="days_overdue" invisible="days_overdue == 0"/>
                            <field name="fixed_date" invisible="state not in ['fixed', 'verified', 'closed']"/>
                            <field name="verified_date" invisible="state not in ['verified', 'closed']"/>
                        </group>
                    </group>
                    <group>
                        <field name="description" placeholder="Describe the defect in detail..."/>
                    </group>
                    <group>
                        <group string="Source">
                            <field name="inspection_id"/>
                            <field name="response_id"/>
                        </group>
                        <group string="Assignment">
                            <field name="assigned_contractor_id"/>
                            <field name="recheck_inspection_id"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Cost" name="cost">
                            <group>
                                <group>
                                    <field name="estimated_cost"/>
                                    <field name="actual_cost"/>
                                    <field name="currency_id" invisible="1"/>
                                </group>
                                <group>
                                    <field name="cost_approved"/>
                                    <field name="cost_approved_by" invisible="not cost_approved"/>
                                    <field name="cost_approved_date" invisible="not cost_approved"/>
                                    <button name="action_approve_cost" string="Approve Cost" type="object" class="btn-primary" invisible="cost_approved or estimated_cost == 0"/>
                                </group>
                            </group>
                            <group string="Tenant Liability">
                                <field name="is_tenant_liable"/>
                                <field name="tenant_liability_reason" invisible="not is_tenant_liable"/>
                            </group>
                        </page>
                        <page string="Access Attempts" name="access">
                            <field name="access_attempt_ids">
                                <list editable="bottom">
                                    <field name="attempt_date"/>
                                    <field name="result"/>
                                    <field name="contractor_id"/>
                                    <field name="reason"/>
                                    <field name="rescheduled_date"/>
                                </list>
                            </field>
                        </page>
                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Additional notes..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Defect Search View -->
    <record id="view_defect_search" model="ir.ui.view">
        <field name="name">property_fielder.defect.search</field>
        <field name="model">property_fielder.defect</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="property_id"/>
                <field name="fault_code_id"/>
                <field name="assigned_contractor_id"/>
                <separator/>
                <filter name="filter_breached" string="SLA Breached" domain="[('is_breached', '=', True)]"/>
                <filter name="filter_open" string="Open" domain="[('state', 'not in', ['verified', 'closed'])]"/>
                <separator/>
                <filter name="filter_immediate" string="Immediate" domain="[('severity_sla', '=', 'immediate')]"/>
                <filter name="filter_urgent" string="Urgent" domain="[('severity_sla', '=', 'urgent')]"/>
                <separator/>
                <filter name="filter_regulatory" string="Regulatory Faults" domain="[('defect_type', '=', 'regulatory_fault')]"/>
                <filter name="filter_hhsrs" string="HHSRS Hazards" domain="[('defect_type', '=', 'hhsrs_hazard')]"/>
                <separator/>
                <filter name="group_property" string="Property" context="{'group_by': 'property_id'}"/>
                <filter name="group_state" string="Status" context="{'group_by': 'state'}"/>
                <filter name="group_severity" string="Severity" context="{'group_by': 'severity_sla'}"/>
                <filter name="group_contractor" string="Contractor" context="{'group_by': 'assigned_contractor_id'}"/>
            </search>
        </field>
    </record>

    <!-- Defect Action -->
    <record id="action_defect" model="ir.actions.act_window">
        <field name="name">Defects</field>
        <field name="res_model">property_fielder.defect</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="view_defect_search"/>
        <field name="context">{'search_default_filter_open': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No defects found
            </p>
            <p>
                Defects are created from inspection findings or can be logged manually.
            </p>
        </field>
    </record>

    <!-- Breached Defects Action -->
    <record id="action_defect_breached" model="ir.actions.act_window">
        <field name="name">SLA Breached</field>
        <field name="res_model">property_fielder.defect</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="view_defect_search"/>
        <field name="domain">[('is_breached', '=', True)]</field>
    </record>

</odoo>
